{% extends "base.html" %}

{% load static %}

{% block content %}
    <section>
        <div class="gray-bg" style="padding: 4vh 0;">
            <div class="container-fluid">
                <div class="central-meta m-0 p-0">
                    <div class="messages">
                        <div class="row h-100 w-100 p-0 m-0">
                            <div class="col-5 col-sm-4 col-lg-3 conversations p-10">
                                <div class="row h-15 w-100 p-0 m-0">
                                    <h5 class="f-title m-0">Conversas</h5>
                                </div>
                                <div class="row h-85 w-100 p-0 m-0">
                                    <ul class="peoples w-100 m-0 h-100">
                                        {% for people in peoples %}
                                            <li class="h-100">
                                                <a onclick="update('{{people.username}}');" style="display: block;">
                                                    <figure>
                                                    {% if people.role == bot %}
                                                        <img src={% static 'website/img/logo.png' %} alt="">
                                                    {% elif people.role == profissional %}
                                                        <img src="{{people.profissional.picture.url}}" alt="">
                                                    {% else %}
                                                        <img src={% static 'website/img/logo.png' %} alt="">
                                                    {% endif %}
                                                    </figure>
                                                    <div class="people-name">
                                                        <span><b>{{people.username}}</b></span>
                                                    </div>
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="col-7 col-sm-8 col-lg-9 message-box p-10">
                                <div class="peoples-mesg-box h-100 w-100 p-0">
                                    <div class="row p-0 m-0 vh-11">
                                        <div class="col-10 conversation-head">
                                            <figure>
                                                {% if you_chat_user.role == bot %}
                                                    <img src={% static 'website/img/logo.png' %} alt="">
                                                {% elif you_chat_user.role == profissional %}
                                                    <img src="{{you_chat_user.profissional.picture.url}}" alt="">
                                                {% else %}
                                                    <img src={% static 'website/img/logo.png' %} alt="">
                                                {% endif %}
                                            </figure>
                                            <span>{{you_chat_user.username}}</span>
                                        </div>
                                        <div class="col-2 conversation-head">
                                            <div class="dropdown">
                                                <button class="btn btn-secondary" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="fa fa-align-justify"></i>
                                                </button>
                                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                    <a class="dropdown-item" href="{% url 'finish_chat' %}">Encerrar Relação</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row p-0 m-0 vh-52">
                                        <div class="col h-100 message">
                                            <ul class="chatting-area" id="chat-text">
                                                {% for message in messages %}
                                                    <li class="{{message.type}}">
                                                        <p>{{message.context}}</p>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="row p-0 m-0 vh-8">
                                        <div class="col message-text-container h-100 w-100 p-0">
                                            <div class="text-area">
                                                <textarea id="input-text"></textarea>
                                            </div>
                                            <button id="submit" title="send"><i class="fa fa-paper-plane"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% comment %} Get data for username and chatbox name{% endcomment %}
    {{ user_id|json_script:"userId" }}
    {{ chat_room.id|json_script:"roomId" }}
    {{ chat_room.slug|json_script:"roomName" }}
{% endblock %}

{% block extra_js %}
    <script>
        const chat_text = document.querySelector('#chat-text');
        chat_text.scrollTop = chat_text.scrollHeight;

        const userId = JSON.parse(document.getElementById('userId').textContent);
        const chatRoomId = JSON.parse(document.getElementById('roomId').textContent);
        const chatRoomSlug = JSON.parse(document.getElementById('roomName').textContent);
        const chatSocket = new WebSocket(
            'ws://' +
            window.location.host +
            '/ws/chat/' +
            chatRoomSlug +
            '/'
        );
        chatSocket.onopen = function (e) {
            console.log("The connection was setup successfully !");
        };
        chatSocket.onclose = function (e) {
            console.log("Something unexpected happened !");
        };


        document.querySelector("#input-text").focus();
        document.querySelector("#input-text").onkeyup = function (e) {
          if (e.keyCode == 13 && !e.shiftKey && !e.altKey && !e.ctrlKey) {
            document.querySelector("#submit").click();
          }
        };
        document.querySelector('#submit').onclick = function (e) {
            const messageInputDom = document.querySelector('#input-text');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'message': message,
                'user_id': userId,
                'chat_room_id': chatRoomId,
            }));
            messageInputDom.value = '';
        };


        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            
            if (data.user_id == userId) {
                chat_text.innerHTML += ('<li class="me"><p>' + data.message + '</p></li>');
            } else {
                chat_text.innerHTML += ('<li class="you"><p>' + data.message + '</p></li>');
            }
            chat_text.scrollTop = chat_text.scrollHeight;
        }
    </script>
    <script>
        function update(userName) {
            let params = new URLSearchParams(document.location.search);
            if (params.get("user")) {
                params.set("user", userName);
            } else {
                params.append("user", userName);
            }
            window.location.search = params.toString();
        }
    </script>
{% endblock %}
